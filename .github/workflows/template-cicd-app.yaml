name: Shared CI-CD Template

on:
  workflow_call:
    inputs:

      acr_login_server:
        required: true
        type: string

      acr_repository:
        required: true
        type: string

      aks_rg:
        required: true
        type: string

      aks_cluster_name:
        required: true
        type: string

      helm_release_name:
        required: true
        type: string

      helm_chart_path:
        required: true
        type: string

      helm_namespace:
        required: true
        type: string

      helm_values_file:
        required: true
        type: string

    secrets:
      AZURE_CREDENTIALS:
        required: true
      helm_set_args:
        required: true
      token_env:
        required: true

jobs:

  build_deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || github.ref_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ inputs.acr_login_server }}
          username:     ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password:     ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      - id: meta
        name: Generate Image Tag
        run: echo "tag=${GITHUB_SHA:0:7}" >> "$GITHUB_OUTPUT"

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:${{ steps.meta.outputs.tag }}
            ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:latest

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:${{ steps.meta.outputs.tag }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'

          
      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/latest/download/kubelogin-linux-amd64.zip
          sudo apt-get install unzip -y
          unzip kubelogin-linux-amd64.zip
          sudo mv bin/linux_amd64/kubelogin /usr/local/bin/kubelogin

      - uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ inputs.aks_rg }}
          cluster-name:   ${{ inputs.aks_cluster_name }}

      - run: kubelogin convert-kubeconfig -l azurecli

      # Expand TOKEN_ENV into real env vars for this job
      - name: Export token env vars
        run: |
          echo "Expanding TOKEN_ENV into environment variables..."
          cat << 'EOF' >> "$GITHUB_ENV"
          ${{ secrets.token_env }}
          EOF


      # NEW STEP: Replace tokens in values file before Helm deploy
      - name: Replace tokens in Helm values file
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["${{ inputs.helm_values_file }}"]'
          tokenPrefix: "#{"
          tokenSuffix: "}#"
          
      - name: Run Script Debug
        run: |
          ls -la 

      - name: Run Script Debug
        run: |
          set -euo pipefail
          cat ./helmchart/config/override-values.yaml

      - name: Debug values file path
        run: |
          echo "Helm values file: ${{ inputs.helm_values_file }}"
          ls -lah .
          ls -lah $(dirname "${{ inputs.helm_values_file }}") || true
          cat "${{ inputs.helm_values_file }}" || echo "‚ùå File not found!"
      
      - name: Deploy Helm Release
        env:
          HELM_SET_ARGS: ${{ secrets.helm_set_args }}
        run: |
          set -e

          echo "Using HELM_SET_ARGS: ${HELM_SET_ARGS:+(provided)}"

          helm upgrade --install "${{ inputs.helm_release_name }}" "${{ inputs.helm_chart_path }}" \
            --namespace "${{ inputs.helm_namespace }}" --create-namespace \
            -f "${{ inputs.helm_values_file }}" \
            --set image.repository="${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}" \
            --set image.tag="${{ steps.meta.outputs.tag }}" \
            ${HELM_SET_ARGS} 
