name: Shared CI-CD Template

on:
  workflow_call:
    inputs:
      environment_name:
        required: true
        type: string

      runs-on:
        description: "Runner label(s) for the job"
        required: false
        type: string
        default: "arc-aks-runners"

      docker_context:
        required: false
        type: string
        default: .

      dockerfile_path:
        required: false
        type: string
        default: Dockerfile

      acr_login_server:
        required: true
        type: string

      acr_repository:
        required: true
        type: string

      aks_rg:
        required: true
        type: string

      aks_cluster_name:
        required: true
        type: string

      helm_release_name:
        required: true
        type: string

      helm_chart_path:
        required: true
        type: string

      helm_namespace:
        required: true
        type: string

      helm_values_file:
        required: true
        type: string

      helm_repo_name:
        required: true
        type: string

      helm_repo_url:
        required: true
        type: string

      helm_chart_name:
        required: true
        type: string

      helm_chart_version:
        required: false
        type: string

      helm_chart_download_dir:
        required: false
        type: string
        default: helm-chart

    secrets:
      AZURE_CREDENTIALS:
        required: true
      helm_set_args:
        required: false
      token_env:
        required: true

jobs:

  build_deploy:
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment_name }}

    steps:
      - uses: actions/checkout@v4

      # NEW: make sure base tools + Azure CLI exist
      - name: Ensure CLI dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e

          echo "Updating apt cache..."
          sudo apt-get update -y

          echo "Installing base utilities..."
          sudo apt-get install -y \
            curl \
            unzip \
            ca-certificates \
            gnupg \
            lsb-release \
            git

          echo "Checking for Azure CLI..."
          if ! command -v az >/dev/null 2>&1; then
            echo "Azure CLI not found, installing..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          else
            echo "Azure CLI already installed, skipping."
          fi

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ inputs.acr_login_server }}
          username:     ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password:     ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      - id: meta
        name: Generate Image Tag
        run: echo "tag=${GITHUB_SHA:0:7}" >> "$GITHUB_OUTPUT"

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.docker_context }}
          file: ${{ inputs.dockerfile_path }}
          push: true
          tags: |
            ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:${{ steps.meta.outputs.tag }}
            ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:latest

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}:${{ steps.meta.outputs.tag }}
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'

      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4
        
      - name: Add centralized Helm repo
        run: |
          helm repo add "${{ inputs.helm_repo_name }}" "${{ inputs.helm_repo_url }}"
          helm repo update

      - name: Download Helm chart from centralized repo
        run: |
          set -e

          mkdir -p "${{ inputs.helm_chart_download_dir }}"

          if [ -n "${{ inputs.helm_chart_version }}" ]; then
            helm pull \
              "${{ inputs.helm_repo_name }}/${{ inputs.helm_chart_name }}" \
              --version "${{ inputs.helm_chart_version }}" \
              --untar \
              --untardir "${{ inputs.helm_chart_download_dir }}"
          else
            helm pull \
              "${{ inputs.helm_repo_name }}/${{ inputs.helm_chart_name }}" \
              --untar \
              --untardir "${{ inputs.helm_chart_download_dir }}"
          fi

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/latest/download/kubelogin-linux-amd64.zip
          sudo apt-get install unzip -y
          unzip kubelogin-linux-amd64.zip
          sudo mv bin/linux_amd64/kubelogin /usr/local/bin/kubelogin

      - uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ inputs.aks_rg }}
          cluster-name:   ${{ inputs.aks_cluster_name }}

      - run: kubelogin convert-kubeconfig -l azurecli

      # Expand TOKEN_ENV into real env vars for this job
      - name: Export token env vars
        run: |
          echo "Expanding TOKEN_ENV into environment variables..."
          cat << 'EOF' >> "$GITHUB_ENV"
          ${{ secrets.token_env }}
          EOF

      # Replace tokens in values file before Helm deploy
      - name: Replace tokens in Helm values file
        uses: cschleiden/replace-tokens@v1
        with:
          files: '["${{ inputs.helm_values_file }}"]'
          tokenPrefix: "#{"
          tokenSuffix: "}#"

      - name: Deploy Helm Release
        env:
          HELM_SET_ARGS: ${{ secrets.helm_set_args }}
        run: |
          set -e

          CHART_PATH="${{ inputs.helm_chart_download_dir }}/${{ inputs.helm_chart_name }}"

          echo "Deploying chart from: $CHART_PATH"
          echo "Using HELM_SET_ARGS: ${HELM_SET_ARGS:+(provided)}"

          helm upgrade --install "${{ inputs.helm_release_name }}" "$CHART_PATH" \
            --namespace "${{ inputs.helm_namespace }}" \
            --create-namespace \
            -f "${{ inputs.helm_values_file }}" \
            --set image.repository="${{ inputs.acr_login_server }}/${{ inputs.acr_repository }}" \
            --set image.tag="${{ steps.meta.outputs.tag }}" \
            ${HELM_SET_ARGS}
