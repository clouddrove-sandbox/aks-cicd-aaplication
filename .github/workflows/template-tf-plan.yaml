name: "ğŸŒ Terraform Plan (Reusable)"

on:
  workflow_call:
    inputs:
      working_directory:
        description: "Root directory of the Terraform configuration"
        required: true
        type: string
        default: ""
      backend_config:
        description: "Terraform backend config flags (space-separated)"
        required: false
        type: string
        default: ""
      terraform_version:
        description: "Terraform version"
        required: false
        type: string
        default: "1.13.3"
      plan_command:
        description: "Terraform plan command."
        required: false
        type: string
        default: "terraform plan -out=tfplan"
    secrets:
      AZURE_CREDENTIALS:
        description: "Azure Credentials to authenticate Azure CLI"
        required: true
      MODULE_GITHUB_TOKEN:
        description: "PAT with repo read access for private Terraform modules"
        required: true

jobs:
  plan:
    name: "Terraform Plan"
    runs-on: arc-aks-runners

    env:
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v5

      # ğŸ‘‡ IMPORTANT: make sure Node.js + base tools + Azure CLI exist (for self-hosted)
      - name: ğŸ”§ Ensure Node.js & CLI dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          set -e

          # ----- Node.js (required for JavaScript actions) -----
          if ! command -v node >/dev/null 2>&1; then
            echo "Node.js not found, installing Node 20..."
            if command -v apt-get >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get update -y
              sudo apt-get install -y nodejs
            else
              echo "apt-get not available; install Node.js manually on this runner."
              exit 1
            fi
          else
            echo "Node.js present: $(node -v)"
          fi

          # ----- Base packages (useful for Az + general) -----
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y \
              curl \
              unzip \
              git \
              ca-certificates \
              gnupg \
              lsb-release
          fi

          # ----- Azure CLI (for azure/login when using auth-type=azurecli/kubelogin later) -----
          if ! command -v az >/dev/null 2>&1; then
            echo "Azure CLI not found, installing..."
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          else
            echo "Azure CLI already installed: $(az version | head -n 1 || true)"
          fi

      - name: â˜ï¸ Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: ğŸ§¹ Terraform Format Check
        uses: dflook/terraform-fmt-check@v2
        with:
          actions_subcommand: fmt
      
      - name: ğŸ” Configure git for private Terraform modules
        run: |
          git config --global url."https://x-access-token:${MODULE_GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          MODULE_GITHUB_TOKEN: ${{ secrets.MODULE_GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init ${{ inputs.backend_config }}
        working-directory: ${{ inputs.working_directory }}

      - name: ğŸ” Terraform Validate
        uses: dflook/terraform-validate@v2
        with:
          working-directory: ${{ inputs.working_directory }}

      - name: ğŸ“‹ Terraform Plan
        run: ${{ inputs.plan_command }}
        working-directory: ${{ inputs.working_directory }}

