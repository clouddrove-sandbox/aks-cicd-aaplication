name: Deploy Addons to AKS - Prod

on:
  workflow_dispatch:
    inputs:  
      deploy_signoz:
        description: "Deploy / upgrade SigNoz chart?"
        required: true
        type: boolean
        default: false
      deploy_postgres:
        description: "Deploy / upgrade Postgres chart?"
        required: true
        type: boolean
        default: false
      deploy_grafana:
        description: "Deploy / upgrade Grafana chart?"
        required: true
        type: boolean
        default: false

jobs:
  deploy-prod:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    environment:
      name: prod

    env:
      # AKS Cluster
      AKS_CLUSTER_NAME: hugin-test-aks
      AKS_RG: hugin-test-rg
      K8S_NAMESPACE: prod-monitoring

      # Chart Values Files
      SIGNOZ_VALUES: ./helmchart-signoz/config/signoz-prod-values.yaml
      POSTGRES_VALUES: ./helmchart-postgres/config/postgres-prod-values.yaml
      GRAFANA_VALUES: ./helmchart-grafana/config/grafana-prod-values.yaml

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: azure/setup-kubectl@v4
      - uses: azure/setup-helm@v4

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/latest/download/kubelogin-linux-amd64.zip
          sudo apt-get install unzip -y
          unzip kubelogin-linux-amd64.zip
          sudo mv bin/linux_amd64/kubelogin /usr/local/bin/kubelogin

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}

      - run: kubelogin convert-kubeconfig -l azurecli

      # üîÅ Replace tokens in Helm override values files
      - name: Replace tokens in Helm values files
        uses: cschleiden/replace-tokens@v1
        with:
          tokenPrefix: "#{"
          tokenSuffix: "}#"
          files: |
            ${{ env.SIGNOZ_VALUES }}
            ${{ env.POSTGRES_VALUES }}
            ${{ env.GRAFANA_VALUES }}
        env: 
          GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}

          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}

          SIGNOZ_USER: ${{ secrets.SIGNOZ_USER }}
          SIGNOZ_PASSWORD: ${{ secrets.SIGNOZ_PASSWORD }}
          SIGNOZ_URL: ${{ secrets.SIGNOZ_URL }}

      # üöÄ Deploy selected Helm releases
      - name: Deploy SigNoz (Prod)
        if: ${{ inputs.deploy_signoz == true }}
        run: |
          helm upgrade --install signoz ./helmchart-signoz \
            -f "${{ env.SIGNOZ_VALUES }}" \
            --namespace "${K8S_NAMESPACE}" \
            --create-namespace \
            --wait \
            --rollback-on-failure

      - name: Deploy Postgres (Prod)
        if: ${{ inputs.deploy_postgres == true }}
        run: |
          helm upgrade --install postgres ./helmchart-postgres \
            -f "${{ env.POSTGRES_VALUES }}" \
            --namespace "${K8S_NAMESPACE}" \
            --create-namespace \
            --wait \
            --rollback-on-failure

      - name: Deploy Grafana (Prod)
        if: ${{ inputs.deploy_grafana == true }}
        run: |
          helm upgrade --install grafana ./helmchart-grafana \
            -f "${{ env.GRAFANA_VALUES }}" \
            --namespace "${K8S_NAMESPACE}" \
            --create-namespace \
            --wait \
            --rollback-on-failure