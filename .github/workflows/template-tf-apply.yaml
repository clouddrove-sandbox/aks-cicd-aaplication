name: "ğŸš€ Terraform Apply (Reusable)"

on:
  workflow_call:
    inputs:
      working_directory:
        description: "Root directory of the Terraform configuration"
        required: true
        type: string
        default: ""
      backend_config:
        description: "Terraform backend config flags (space-separated)"
        required: false
        type: string
        default: ""
      timeout:
        description: "Timeout (minutes) for manual approval"
        required: false
        type: number
        default: 10
      approvers:
        description: "Comma-separated GitHub usernames allowed to approve"
        required: false
        type: string
        default: ""
      minimum_approvals:
        description: "Minimum approvals required"
        required: false
        type: number
        default: 1
      plan_command:
        description: "Terraform plan command."
        required: false
        type: string
        default: "terraform plan -out=tfplan"
      apply_command:
        description: "Terraform apply command."
        required: false
        type: string
        default: "terraform apply -auto-approve -tfplan"
      terraform_version:
        description: "Terraform version"
        required: false
        type: string
        default: "1.13.3"
    secrets:
      AZURE_CREDENTIALS:
        description: "Azure Credentials to authenticate Azure CLI"
        required: true
      MODULE_GITHUB_TOKEN:
        description: "PAT with repo read access for private Terraform modules"
        required: true

jobs:
  apply:
    name: "Terraform Apply"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v5

      - name: â˜ï¸ Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ”§ Install Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}
      
      - name: ğŸ” Configure git for private Terraform modules
        run: |
          git config --global url."https://x-access-token:${MODULE_GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
        env:
          MODULE_GITHUB_TOKEN: ${{ secrets.MODULE_GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init ${{ inputs.backend_config }}
        working-directory: ${{  inputs.working_directory }}

      - name: ğŸ” Terraform Validate
        uses: dflook/terraform-validate@v2
        with:
          working-directory: ${{  inputs.working_directory }}

      - name: ğŸ“‹ Terraform Plan
        run: ${{ inputs.plan_command }}
        working-directory: ${{ inputs.working_directory }}          

      - name: âœ… Manual Approval
        uses: trstringer/manual-approval@v1
        timeout-minutes: ${{ inputs.timeout }}
        with:
          secret: ${{ github.token }}
          approvers: ${{ inputs.approvers }}
          minimum-approvals: ${{ inputs.minimum_approvals }}
          issue-title: "Approve Terraform Apply for ${{ github.ref_name }}"

      - name: ğŸš€ Terraform Apply
        run: ${{ inputs.apply_command }}
        working-directory: ${{  inputs.working_directory }}