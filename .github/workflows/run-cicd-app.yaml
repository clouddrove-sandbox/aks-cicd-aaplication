name: Run CI/CD Pipeline

on:
  push:
    branches: [dev, qa, prod]
  workflow_dispatch:

jobs:
  deploy:
    uses: ./.github/workflows/template-cicd-app.yaml

    with:
      acr_login_server: ${{ vars.ACR_LOGIN_SERVER }}
      acr_repository:   ${{ vars.ACR_REPOSITORY }}
      aks_rg:           ${{ vars.AKS_RG }}
      aks_cluster_name: ${{ vars.AKS_CLUSTER_NAME }}

      helm_release_name: ${{ vars.HELM_RELEASE_NAME }}
      helm_chart_path:   ${{ vars.HELM_CHART_PATH }}
      helm_namespace:    ${{ github.ref_name }}
      helm_values_file:  ${{ vars.HELM_VALUES_FILE }}

    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

      # Optional â€“ only set this when you actually need to override / inject secrets into Helm
      helm_set_args: >-
        --set secret.secrets.DB_URL=${{ secrets.DB_URL }}
        --set secret.secrets.ACCESS_TOKEN=${{ secrets.ACCESS_TOKEN }}
        --set secret.secrets.REFRESH_TOKEN=${{ secrets.REFRESH_TOKEN }}
