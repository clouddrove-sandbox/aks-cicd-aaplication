name: Shared CI - Build & Scan Image

on:
  workflow_call:
    secrets:
      AZURE_CREDENTIALS:
        required: true
      acr_build_args_json:
        required: false

permissions:
  id-token: write
  contents: read

env:
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
  ACR_NAME: ${{ vars.ACR_NAME }}
  ACR_REPOSITORY: ${{ vars.ACR_REPOSITORY }}

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.build.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login
        run: az acr login --name $ACR_NAME

      - id: build
        name: Build & Push Image
        uses: azure/cli@v2
        with:
          inlineScript: |
            SHORT_SHA="${GITHUB_SHA::7}"
            CUSTOM_TAG="$SHORT_SHA"

            mapfile -t BUILD_ARGS < <(
              jq -r 'to_entries[] | "--build-arg=\(.key)=\(.value)"' <<< '${{ secrets.acr_build_args_json }}'
            )

            az acr build \
              --registry "$ACR_NAME" \
              --image "$ACR_REPOSITORY:$CUSTOM_TAG" \
              --image "$ACR_REPOSITORY:latest" \
              --file "Dockerfile" "${BUILD_ARGS[@]}" .

            echo "tag=$CUSTOM_TAG" >> $GITHUB_OUTPUT

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y && sudo apt-get install -y trivy

      - name: Scan Image
        run: trivy image --exit-code 0 --severity HIGH,CRITICAL \
              $ACR_LOGIN_SERVER/$ACR_REPOSITORY:${{ steps.build.outputs.tag }}