name: Shared CI - Build & Scan Image

on:
  workflow_call:
    secrets:
      AZURE_CREDENTIALS:
        required: true

permissions:
  contents: read

env:
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
  ACR_REPOSITORY: ${{ vars.ACR_REPOSITORY }}

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Login to Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login to ACR using Service Principal auth
      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

      # Generate short SHA tag
      - id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "tag=$SHORT_SHA" >> $GITHUB_OUTPUT

      # Build and Push Docker Image using GitHub Action
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.ACR_REPOSITORY }}:${{ steps.meta.outputs.tag }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.ACR_REPOSITORY }}:latest

      # Install Trivy scanning tool
      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] \
            https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      # Security Scan of the pushed image
      - name: Scan Image with Trivy
        run: |
          echo "Scanning image: $ACR_LOGIN_SERVER/$ACR_REPOSITORY:${{ steps.meta.outputs.tag }}"
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
            $ACR_LOGIN_SERVER/$ACR_REPOSITORY:${{ steps.meta.outputs.tag }}